<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RFQ Module | eazyProcure</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{ --sidebar-width: 260px; --navbar-height: 64px; --accent: #0d6efd; --muted: #6c757d; } html,body { height: 100%; margin: 0; font-family: "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial; background: #f8f9fa; } /* NAVBAR (light green) */ .topbar { height: var(--navbar-height); background: #7dd170; /* light green */ display: flex; align-items: center; justify-content: space-between; padding: 0 16px; position: fixed; left: var(--sidebar-width); right: 0; top: 0; z-index: 1100; box-shadow: 0 2px 6px rgba(0,0,0,0.08); transition: left .25s ease; } .nav-actions { display: flex; align-items: center; gap: 15px; } .nav-icon { cursor: pointer; font-size: 1.2rem; position: relative; } .icon-badge::after { content: attr(data-count); position: absolute; top: -6px; right: -8px; background: red; color: white; font-size: 0.7rem; padding: 2px 5px; border-radius: 50%; display: none; } .icon-badge[data-count]:not([data-count="0"])::after { display: inline-block; } /* brand */ .brand { font-weight: 700; color: #134611; } /* navbar right icons spacing & style */ .nav-actions { display: flex; align-items: center; gap: 10px; } .nav-icon { display: inline-flex; align-items: center; justify-content: center; padding: 8px; margin-left: 8px; border-radius: 8px; cursor: pointer; color: #13340f; transition: background .2s, transform .12s; } .nav-icon:hover { background: rgba(0,0,0,0.06); transform: translateY(-1px); } .nav-icon .bi { font-size: 1.15rem; } /* small badge for counts (optional style) */ .icon-badge { position: relative; } .icon-badge .badge { position: absolute; top: -6px; right: -6px; font-size: 0.6rem; } /* layout: sidebar + content */ .layout { display: flex; min-height: 100vh; } /* Sidebar (light) */ .sidebar { width: var(--sidebar-width); background: #f1f5f2; padding: 18px 12px; padding-top: calc(var(--navbar-height) + 14px); /* start under navbar */ position: fixed; top: 0; left: 0; bottom: 0; overflow-y: auto; box-shadow: 2px 0 6px rgba(0,0,0,0.04); transition: transform .28s ease; z-index: 1050; } .sidebar.collapsed { transform: translateX(-110%); } .sidebar .nav-section { margin-bottom: 6px; } .sidebar .nav-link { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 9px 10px; color: #213426; border-radius: 8px; text-decoration: none; margin-bottom: 4px; transition: background .18s; } .sidebar .nav-link:hover { background: #e6f0e6; color: #0d6efd; } .sidebar .nav-left { display: flex; gap: 10px; align-items: center; } .sidebar .nav-left .bi { font-size: 1.05rem; color: var(--accent); } /* submenu slide (animated) */ .submenu { max-height: 0; overflow: hidden; transition: max-height .32s ease, padding .2s ease; padding-left: 36px; } .submenu.show { max-height: 420px; /* enough room */ padding-top: 8px; padding-bottom: 8px; } .submenu a { display:block; padding:8px 12px; text-decoration:none; color:#183f28; border-radius:6px; margin-bottom:4px; } .submenu a:hover { background:#e6f0e6; color:var(--accent); } /* main content area */ .content { margin-left: var(--sidebar-width); margin-top: var(--navbar-height); padding: 22px; flex: 1; transition: margin-left .28s ease; } .sidebar.collapsed ~ .content { margin-left: 0; } .sidebar.collapsed ~ .topbar { left: 0; } /* cards grid: 3 on top, 4 on next row */ .cards-top { display: grid; grid-template-columns: repeat(3,1fr); gap: 16px; margin-bottom: 18px; } .cards-bottom { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; margin-bottom: 20px; } .stat-card { border-radius: 12px; padding: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.04); display:flex; align-items:center; gap: 12px; cursor:pointer; transition: transform .16s ease, box-shadow .16s; color: white; } .stat-card:hover { transform: translateY(-6px); box-shadow: 0 12px 28px rgba(0,0,0,0.06); } .stat-icon { width:56px;height:56px;border-radius:10px; display:flex;align-items:center;justify-content:center;font-size:1.6rem;color:white; flex-shrink:0; } .stat-body { flex:1; } .stat-title { font-size:0.85rem;color:var(--muted); margin:0; } .stat-value { font-size:1.55rem;font-weight:700;margin:4px 0 0;color:#222; } /* colored icon backgrounds */ .c-admin{background: linear-gradient(135deg,#3b82f6,#2563eb);} /* blue */ .c-client{background: linear-gradient(135deg,#10b981,#059669);} /* green */ .c-supplier{background: linear-gradient(135deg,#fb923c,#f97316);}/* orange */ .c-open{background: linear-gradient(135deg,#06b6d4,#0891b2);} /* teal */ .c-closed{background: linear-gradient(135deg,#94a3b8,#6b7280);} /* gray */ .c-applied{background: linear-gradient(135deg,#f59e0b,#d97706);} /* amber */ .c-approved{background: linear-gradient(135deg,#7c3aed,#6d28d9);} /* purple */ /* Open tenders table */ .table-card { margin-top: 8px; background: white; padding: 14px; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.03); } /* popups anchored to icons */ .floating-popup { position: absolute; width: 260px; max-width: 40vw; background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.12); padding: 10px; z-index: 1200; display: none; } .floating-popup .item { display:flex; gap:10px; align-items:center; padding:8px 6px; border-bottom:1px solid #f0f0f0; } .floating-popup .item:last-child{border-bottom:none;} .floating-popup .item .bi { font-size:1.05rem; color:var(--accent); width:28px; text-align:center; } .floating-popup h6{margin:0 0 8px 0;font-size:0.95rem;color:var(--accent);} /* Responsive */ @media (max-width: 991px) { .cards-top { grid-template-columns: repeat(2,1fr); } .cards-bottom { grid-template-columns: repeat(2,1fr); } } @media (max-width: 768px) { .topbar { left: 0; padding: 0 10px; } .sidebar { transform: translateX(-110%); position: fixed; z-index:1300; } .sidebar.visible { transform: translateX(0); } .content { margin-left: 0; padding: 14px; margin-top: var(--navbar-height); } .cards-top { grid-template-columns: 1fr; } .cards-bottom { grid-template-columns: repeat(2,1fr); } } /* --- Top Navbar Styling --- */ .navbar-custom { margin-left: 260px; /* keeps space for sidebar */ background: #90ee90; /* light green */ padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; } .navbar-custom .left span { font-size: 1.3rem; font-weight: bold; color: #1e1e2f; } .navbar-custom .right { display: flex; align-items: center; gap: 25px; /* spacing between icons */ } .icon-wrapper { position: relative; cursor: pointer; } .icon-wrapper i { font-size: 1.4rem; color: #1e1e2f; } .icon-wrapper .badge { position: absolute; top: -5px; right: -10px; background: red; color: #fff; font-size: 0.7rem; border-radius: 50%; padding: 3px 6px; } /* Dropdown menus for email, sms, notification */ .navbar-custom .dropdown-menu { min-width: 250px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px; border: none; } .navbar-custom .dropdown-menu .dropdown-item { font-size: 0.9rem; display: flex; align-items: center; gap: 8px; } .navbar-custom .dropdown-menu .dropdown-item i { font-size: 1rem; color: #0d6efd; } /* Profile dropdown */ .navbar-custom .dropdown-menu .dropdown-item.text-danger { color: #dc3545 !important; } .navbar-custom .dropdown-menu .dropdown-item.text-danger:hover { background: #f8d7da; color: #a71d2a !important; } /* Responsive tweaks */ @media (max-width: 768px) { .navbar-custom { margin-left: 0; flex-wrap: wrap; } .navbar-custom .left { width: 100%; margin-bottom: 10px; } .navbar-custom .right { width: 100%; justify-content: flex-end; } }
    html,body { height:100%; margin:0; font-family: "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial; background:#f8f9fa; }
    .topbar { height:var(--navbar-height); background:#7dd170; display:flex; align-items:center; padding:0 16px; position:fixed; left:var(--sidebar-width); right:0; top:0; z-index:1100; box-shadow:0 2px 6px rgba(0,0,0,.08); }
    .sidebar { width:var(--sidebar-width); background:#f1f5f2; padding:18px 12px; padding-top:calc(var(--navbar-height)+14px); position:fixed; top:0; left:0; bottom:0; overflow:auto; box-shadow:2px 0 6px rgba(0,0,0,.04); z-index:1050; }
    .content { margin-left:var(--sidebar-width); margin-top:var(--navbar-height); padding:22px; min-height:100vh; }
    .table-card { background:white; padding:14px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.03); }
    /* small responsive tweaks */
    @media (max-width: 768px) { .sidebar { transform:translateX(-110%); position:fixed; z-index:1300; } .content { margin-left:0; } .topbar { left:0; } }
  </style>
</head>
<body>

  <!-- Sidebar (placeholder) -->
<%- include('partials/sidebar') %>

  <!-- Topbar (placeholder) -->
<%- include('partials/topbar') %>

  <!-- Main content -->
  <main class="content">
    <div class="container-fluid">

      <h2 class="text-center mb-4 text-primary">Request for Quotation (RFQ)</h2>

      <!-- Tabs -->
      <ul class="nav nav-tabs" id="rfqTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="newjob-tab" data-bs-toggle="tab" data-bs-target="#newJob" type="button" role="tab">New Job</button>
        </li>

        <li class="nav-item" role="presentation">
          <button class="nav-link" id="create-tab" data-bs-toggle="tab" data-bs-target="#create" type="button" role="tab">Create RFQ</button>
        </li>

        <li class="nav-item" role="presentation">
          <button class="nav-link" id="bids-tab" data-bs-toggle="tab" data-bs-target="#bids" type="button" role="tab">Submitted RFQ</button>
        </li>
      </ul>

      <!-- Tab content -->
      <div class="tab-content bg-white border border-top-0 p-4" id="rfqTabsContent">

        <!-- NEW JOB (only this has show active initially) -->
        <div class="tab-pane fade show active" id="newJob" role="tabpanel" aria-labelledby="newjob-tab">
          <h5 class="text-success mb-3">Create New Job</h5>

          <!-- Note: using your original action '/create_jobrfq' so backend redirect flow is preserved -->
          <form id="newJobForm" action="/create_jobrfq" method="post" class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Select Client</label>
              <select name="client" class="form-select" required>
                <option value="">Select Client</option>
                <% if (test && test.length > 0) { %>
                  <% test.forEach(tests => { %>
                    <option value="<%= tests.name %>"><%= tests.name %></option>
                  <% }) %>
                <% } else { %>
                  <option disabled>No clients found</option>
                <% } %>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Bid Title</label>
              <input type="text" name="bid_title" class="form-control" placeholder="Enter bid title" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">Start Date & Time</label>
              <input type="datetime-local" name="start_datetime" class="form-control" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">Closing Date & Time</label>
              <input type="datetime-local" name="closing_datetime" class="form-control" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">Eligibility Criteria</label>
              <select name="eligibility[]" class="form-select" >
                <option value="All">All</option>
                <option value="Youth">Youth</option>
                <option value="Women">Women</option>
                <option value="PWDs">PWDs</option>
              </select>
              <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
            </div>

            <div class="col-12">
              <button type="submit" class="btn btn-primary">Create Job</button>
            </div>
          </form>
        </div>

        <!-- CREATE RFQ -->
        <div class="tab-pane fade" id="create" role="tabpanel" aria-labelledby="create-tab">
          <h5 class="mb-3 text-success">Create RFQ Document</h5>

          <!-- keep your action '/create_rfq' -->
          <form id="createRfqForm" action="/create_rfq" method="post">
            <!-- If job id stored in session on backend, you may not need this; keep for linking -->
            <input type="hidden" name="job_id" id="job_id">

            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label class="form-label">RFQ Title</label>
                <input type="text" name="title" class="form-control" placeholder="Enter RFQ title" required>
              </div>

              <div class="col-md-6">
                <label class="form-label">Delivery Timeline</label>
                <input type="date" name="delivery_timeline" class="form-control">
              </div>
                   <!-- Template -->
      <div class="col-12">
        <label class="form-label">Select Template</label>
        <select name="template" class="form-select" required>
          <option value="">-- Select --</option>
          <option value="goods">Goods</option>
          <option value="service">Service</option>
          <option value="works">Works</option>
        </select>
      </div>
              <div class="col-12">
                <label class="form-label">Specifications</label>
                <textarea class="form-control" name="specifications" rows="3" placeholder="Enter product/service specifications"></textarea>
              </div>
            </div>

            <!-- Items table -->
            <div class="table-responsive table-card mb-3">
              <table class="table table-sm" id="itemsTable">
                <thead class="table-light">
                  <tr>
                    <th style="width:40px">#</th>
                    <th>Description</th>
                    <th style="width:110px">Quantity</th>
                    <th style="width:140px">Unit price</th>
                    <th style="width:140px">VAT (%)</th>
                    <th style="width:140px">Total price</th>
                    <th style="width:80px"></th>
                  </tr>
                </thead>
                <tbody>
                  <!-- initial blank row -->
                </tbody>
              </table>

              <div class="d-flex gap-2">
                <button type="button" class="btn btn-sm btn-outline-success" id="addItemBtn"><i class="bi bi-plus-lg"></i> Add Item</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="clearItemsBtn">Clear Items</button>
              </div>
            </div>

            <!-- Summary -->
            <div class="row g-3 mb-3">
              <div class="col-md-4 ms-auto">
                <div class="card p-3">
                  <div class="d-flex justify-content-between">
                    <div>Sub-total</div>
                    <div id="subTotal">0.00</div>
                  </div>
                  <div class="d-flex justify-content-between">
                    <div>Total VAT</div>
                    <div id="totalVat">0.00</div>
                  </div>
                  <hr />
                  <div class="d-flex justify-content-between fw-bold">
                    <div>Grand Total</div>
                    <div id="grandTotal">0.00</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Payment Terms</label>
              <input type="text" name="payment_terms" class="form-control" placeholder="e.g., 30 days after delivery">
            </div>

            <button type="submit" class="btn btn-primary">Create RFQ</button>
          </form>
        </div>

        <!-- SUBMITTED BIDS -->
        <div class="tab-pane fade" id="bids" role="tabpanel" aria-labelledby="bids-tab">
          <h5 class="mb-3 text-success">Submitted Bids</h5>

<div class="table-card">
  <table class="table table-borderless" id="submittedTable">
    <thead class="table-light">
      <tr>
		  <th>Client</th>
       
        <th>Specification</th>
        <th>Unit price</th>
        <th>Total price</th>
        <th>Deadline</th>
      </tr>
    </thead>
    <tbody>
      <% if (rfqs && rfqs.length > 0) { %>
        <% rfqs.forEach(rfq => { %>
          <tr>
			  <td><%= rfq.client%></td>
          
            <td><%= rfq.description %></td>
            <td><%= rfq.unit_price ? 'KES ' + rfq.unit_price.toLocaleString() : '-' %></td>
            <td><%= rfq.total_price ? 'KES ' + rfq.total_price.toLocaleString() : '-' %></td>
            <td><%= rfq.delivery_timeline ? rfq.delivery_timeline.toISOString().split('T')[0] : '-' %></td>
                </tr>
        <% }); %>
      <% } else { %>
        <tr>
          <td colspan="6" class="text-center">No RFQs found</td>
        </tr>
      <% } %>
    </tbody>
  </table>
</div>


        </div>

      </div>
    </div>
  </main>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {

  /********* TAB AUTO SWITCH AFTER SUBMIT *********/
  function switchToTab(tabId) {
    const tabTrigger = document.querySelector(`[data-bs-target="${tabId}"]`);
    if(tabTrigger){
      const bsTab = new bootstrap.Tab(tabTrigger);
      bsTab.show();
    }
  }

  // Switch to saved tab on page load
  const goToTab = sessionStorage.getItem('goToTab');
  if(goToTab){
    setTimeout(() => {
      switchToTab(goToTab);
      sessionStorage.removeItem('goToTab');
    }, 50);
  }

  // Set tab before form submission
  const newJobForm = document.getElementById('newJobForm');
  if(newJobForm){
    newJobForm.addEventListener('submit', function() {
      sessionStorage.setItem('goToTab', '#create');
    });
  }

  const createRfqForm = document.getElementById('createRfqForm');
  if(createRfqForm){
    createRfqForm.addEventListener('submit', function() {
      sessionStorage.setItem('goToTab', '#bids');
    });
  }

  /********* ITEMS TABLE & AUTO TOTALS *********/
  const itemsTbody = document.querySelector('#itemsTable tbody');
  const addItemBtn = document.getElementById('addItemBtn');
  const clearItemsBtn = document.getElementById('clearItemsBtn');

  function addItemRow(desc = '', qty = 1, price = 0, vat = 0) {
    const rowIndex = itemsTbody.rows.length + 1;
    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td class="align-middle">${rowIndex}</td>
      <td><input type="text" name="item_description[]" class="form-control form-control-sm" value="${desc}" required></td>
      <td><input type="number" name="quantity[]" class="form-control form-control-sm qty" min="0" value="${qty}" required></td>
      <td><input type="number" name="unit_price[]" class="form-control form-control-sm price" min="0" step="0.01" value="${price}" required></td>
      <td><input type="number" name="vat[]" class="form-control form-control-sm item-vat" min="0" step="0.01" value="${vat}"></td>
      <td class="align-middle text-end item-total-cell">
        <span class="item-total-display">0.00</span>
        <input type="hidden" name="total_price[]" class="item-total-input" value="0.00">
      </td>
      <td class="text-center align-middle">
        <button type="button" class="btn btn-sm btn-danger remove-row">x</button>
      </td>
    `;
    itemsTbody.appendChild(tr);
    calculateTotals();
  }

  function calculateTotals() {
    let subTotal = 0;
    let totalVat = 0;

    itemsTbody.querySelectorAll('tr').forEach(tr => {
      const qty = parseFloat(tr.querySelector('.qty')?.value || 0);
      const price = parseFloat(tr.querySelector('.price')?.value || 0);
      const vatPct = parseFloat(tr.querySelector('.item-vat')?.value || 0);

      const lineBase = qty * price;
      const lineVat = (lineBase * vatPct) / 100;
      const lineTotal = lineBase + lineVat;

      tr.querySelector('.item-total-display').textContent = lineTotal.toFixed(2);
      tr.querySelector('.item-total-input').value = lineTotal.toFixed(2);

      subTotal += lineBase;
      totalVat += lineVat;
    });

    document.getElementById('subTotal').textContent = subTotal.toFixed(2);
    document.getElementById('totalVat').textContent = totalVat.toFixed(2);
    document.getElementById('grandTotal').textContent = (subTotal + totalVat).toFixed(2);
  }

  // Add / clear / remove rows
  addItemBtn.addEventListener('click', () => addItemRow());
  clearItemsBtn.addEventListener('click', () => {
    itemsTbody.innerHTML = '';
    addItemRow();
  });

  itemsTbody.addEventListener('click', e => {
    if(e.target.closest('.remove-row')){
      e.target.closest('tr').remove();
      Array.from(itemsTbody.querySelectorAll('tr')).forEach((tr, idx) => {
        tr.querySelector('td:first-child').textContent = idx + 1;
      });
      calculateTotals();
    }
  });

  itemsTbody.addEventListener('input', e => {
    if(e.target.matches('.qty, .price, .item-vat')) calculateTotals();
  });

  // Initial row
  addItemRow();

});
</script>



</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Questionnaire Page</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Custom CSS -->
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
    }

    .section-title {
      font-size: 1.25rem;
      color: #343a40;
      font-weight: 600;
    }

    .card {
      border-radius: 0.75rem;
    }

    .quiz-card {
      background: #ffffff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .quiz-card h6 {
      font-size: 1rem;
      font-weight: 600;
      color: #495057;
    }

    .quiz-card p {
      margin-bottom: 0.5rem;
    }

    .form-control {
      border-radius: 0.5rem;
    }

    .btn {
      border-radius: 0.5rem;
    }

    #previewArea {
      background: #e9ecef;
      padding: 1rem;
      border-radius: 0.5rem;
      min-height: 50px;
    }
  </style>
</head>
<body>
<div class="container py-5">
<!-- Available Questionnaires -->
<div class="card p-4 shadow-sm mb-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="section-title mb-0 text-success">Available Questionnaires</h5>
    <p class="mb-0 text-end">
      <a href="/admin/dashcl" class="btn btn-sm btn-outline-secondary">Back to Dashboard</a>
    </p>
  </div>

  <% if (uploads && uploads.length > 0) { %>
    <div class="d-flex flex-wrap gap-2">
      <% uploads.forEach(u => { %>
        <button class="btn btn-outline-primary loadQBtn text-success"
                data-job="<%= u.job_id %>"
                data-category="<%= u.category %>"
                data-file="<%= u.file %>">
          Answer Questionnaire - <%= u.category %>
        </button>
      <% }) %>
    </div>
  <% } else { %>
    <p>No questionnaires available</p>
  <% } %>
</div>



  <!-- Hidden Form Area -->
  <div class="card p-4 shadow-sm">
 <h5 class="section-title mb-3 text-success" id="questionnaireTitle">Questionnaire</h5>
   <form id="uploadForm" 
      method="post" 
      action="/admin/submit_questionnaire" 
      enctype="multipart/form-data">

    <input type="hidden" id="job_id" name="job_id" value="">
    <input type="hidden" id="category" name="category" value="">
    <input type="hidden" id="fileInput" name="file" value="">

    <div id="questionnaire"></div>

    <div class="d-flex justify-content-end gap-2 mt-3">
        <button type="button" class="btn btn-success" id="previewBtn">Preview</button>
        <button type="submit" class="btn btn-primary">Save to DB</button>
        <button type="button" class="btn btn-secondary" id="closePreviewBtn" style="display:none;">Close Preview</button>
    </div>
</form>

    <div id="previewArea" class="mt-3"></div>
  </div>

</div>

<!-- JS Dependencies -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
const previewArea = document.getElementById("previewArea");
const closeBtn = document.getElementById("closePreviewBtn");
const questionnaireDiv = document.getElementById("questionnaire");
const jobIdInput = document.getElementById("job_id");
const categoryInput = document.getElementById("category");
const fileInputHidden = document.getElementById("fileInput");

let rows = [];

// Load questionnaire
document.querySelectorAll(".loadQBtn").forEach(btn => {
  btn.addEventListener("click", async () => {
    const jobId = btn.dataset.job;
    const category = btn.dataset.category;
    const filePath = btn.dataset.file;

    jobIdInput.value = jobId;
    categoryInput.value = category;
    fileInputHidden.value = filePath;

    const response = await fetch(`/uploads/${filePath}`);
    const blob = await response.blob();
    const reader = new FileReader();

    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: "array" });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

      const contentRows = rows.slice(1);
      questionnaireDiv.innerHTML = "";

      contentRows.forEach((row, index) => {
        if (!row || row.length < 8) return;

        let [
          section,
          questionId,
          questionTextRaw,
          answerType,
          mandatory,
          options,
          weight,
          attachmentRequired
        ] = row.map(v => String(v || ""));

        const cleanedText = questionTextRaw.trim();
        const isRequired = mandatory.toLowerCase() === "y" ? "required" : "";

        let field = "";

        // Trade references block
        if (cleanedText.toLowerCase().includes("trade references") || cleanedText.toLowerCase().includes("reference")) {
          field = `
            <div class="row g-2 mb-2">
              <div class="col-md"><input type="text" name="orgName" class="form-control" placeholder="Organization Name" ${isRequired} /></div>
              <div class="col-md"><input type="text" name="contactPerson" class="form-control" placeholder="Contact Person" ${isRequired} /></div>
              <div class="col-md"><input type="text" name="designation" class="form-control" placeholder="Designation/Position" ${isRequired} /></div>
            </div>
            <div class="row g-2 mb-2">
              <div class="col-md"><input type="tel" name="telephone" class="form-control" placeholder="Telephone Number" ${isRequired} /></div>
              <div class="col-md"><input type="email" name="email" class="form-control" placeholder="Email Address" ${isRequired} /></div>
            </div>
            <div class="row g-2 mb-2">
              <div class="col-md"><input type="text" name="goods" class="form-control" placeholder="Nature of Goods/Services Supplied" ${isRequired} /></div>
              <div class="col-md"><input type="text" name="contractValue" class="form-control" placeholder="Contract Value (approx.)" ${isRequired} /></div>
            </div>
          `;
        } else {
          // Handle options / validation rule
          if (options && options.includes(",")) {
            const optionItems = options.split(",").map(o => `<option value="${o.trim()}">${o.trim()}</option>`).join("");
            field = `<select name="q${index}" class="form-select mb-2" ${isRequired}>${optionItems}</select>`;
          } else {
            // Handle basic types
            if (answerType.toLowerCase() === "text") field = `<textarea name="q${index}" class="form-control mb-2" ${isRequired}></textarea>`;
            else if (answerType.toLowerCase() === "number") field = `<input type="number" name="q${index}" class="form-control mb-2" ${isRequired} />`;
            else if (answerType.toLowerCase() === "date") field = `<input type="date" name="q${index}" class="form-control mb-2" ${isRequired} />`;
            else field = `<input type="text" name="q${index}" class="form-control mb-2" ${isRequired} />`;
          }
        }

        // Attachment input
        if (attachmentRequired.toLowerCase() === "y") {
          field += `<input type="file" name="attachment${index}" class="form-control mb-2" ${isRequired} />`;
        }

        questionnaireDiv.innerHTML += `
          <div class="quiz-card mb-3 p-3 border rounded">
            <h6>${section} - ${questionId}</h6>
            <p><strong>${cleanedText}</strong>${isRequired ? " *" : ""}</p>
            ${field}
          </div>
        `;
      });

      closeBtn.style.display = "inline-block";
    };

    reader.readAsArrayBuffer(blob);
  });
});

// Update title
const questionnaireTitle = document.getElementById("questionnaireTitle");
document.querySelectorAll(".loadQBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    const category = btn.dataset.category;
    questionnaireTitle.textContent = `Questionnaire: ${category}`;
  });
});

// Close preview
closeBtn.addEventListener("click", () => {
  questionnaireDiv.innerHTML = "";
  previewArea.innerHTML = "";
  closeBtn.style.display = "none";
});
</script>

</body>
</html>
